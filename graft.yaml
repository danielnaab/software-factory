apiVersion: graft/v0
deps:
  meta-knowledge-base: "https://github.com/danielnaab/meta-knowledge-base.git#main"
  living-specifications: "https://github.com/danielnaab/living-specifications.git#main"

commands:
  plan:
    run: "cat"
    description: "Render planning prompt with project state"
    stdin:
      template: templates/plan.md
    context:
      - changes
      - slices

  iterate:
    run: "bash scripts/iterate.sh"
    description: "Generate implementation prompt for next step of a slice"
    args:
      - name: slice
        type: choice
        description: "Slice to iterate on"
        required: true
        positional: true
        options_from: slices

  implement:
    run: "bash scripts/implement.sh {slice}"
    description: "Implement next slice step with Claude Code"
    writes:
      - session
      - context-snapshot
    args:
      - name: slice
        type: choice
        description: "Slice to implement"
        required: true
        positional: true
        options_from: slices

  resume:
    run: "bash scripts/resume.sh {slice}"
    description: "Resume the last implement session for a slice"
    reads:
      - session
    writes:
      - context-snapshot
    args:
      - name: slice
        type: choice
        description: "Slice to resume"
        required: true
        positional: true
        options_from: slices

  verify:
    run: "bash scripts/verify.sh"
    description: "Run consumer project verification (format, lint, tests)"
    writes:
      - verify

  approve:
    run: "bash scripts/approve.sh"
    description: "Approve a pending checkpoint"
    reads:
      - checkpoint
    writes:
      - checkpoint

  reject:
    run: "bash scripts/reject.sh"
    description: "Reject a pending checkpoint"
    reads:
      - checkpoint
    writes:
      - checkpoint

  review:
    run: "bash scripts/review.sh"
    description: "Adversarial self-review of implementation diff against acceptance criteria (advisory)"
    reads:
      - session
    writes:
      - review

  diagnose:
    run: "bash scripts/diagnose.sh"
    description: "Targeted root-cause analysis for verify failures"
    reads:
      - verify
      - session
    writes:
      - diagnose

  spec-check:
    run: "bash scripts/spec-check.sh"
    description: "Map acceptance criteria to implementation evidence in the diff"
    reads:
      - session
    writes:
      - spec-check

  new-slice:
    run: "bash scripts/new-slice.sh {description}"
    description: "Draft a new slice plan from a feature description"
    args:
      - name: description
        type: string
        description: "Feature description for the new slice"
        required: true
        positional: true

  implement-parallel:
    run: "bash scripts/implement-parallel.sh {slice1} {slice2} {slice3} {slice4}"
    description: "Run multiple independent slices in parallel using git worktrees"
    args:
      - name: slice1
        type: string
        description: "First slice to implement"
        required: true
        positional: true
      - name: slice2
        type: string
        description: "Second slice to implement"
        required: true
        positional: true
      - name: slice3
        type: string
        description: "Third slice to implement (optional)"
        required: false
        positional: true
      - name: slice4
        type: string
        description: "Fourth slice to implement (optional)"
        required: false
        positional: true

sequences:
  implement-verified:
    description: "Implement next slice step and verify, retrying on verify failure"
    steps:
      - implement
      - verify
    on_step_fail:
      step: verify
      recovery: resume
      max: 3
    checkpoint: true
    args:
      - name: slice
        type: choice
        description: "Slice to implement"
        required: true
        positional: true
        options_from: slices

  implement-reviewed:
    description: "Implement, verify (with retry), and self-review before human checkpoint"
    steps:
      - implement
      - verify
      - review
    on_step_fail:
      step: verify
      recovery: resume
      max: 3
    checkpoint: true
    args:
      - name: slice
        type: choice
        description: "Slice to implement"
        required: true
        positional: true
        options_from: slices

state:
  slices:
    run: "bash scripts/list-slices.sh"
    cache:
      deterministic: false
    timeout: 10

  changes:
    run: "bash -c 'commits=$(git log --oneline -10); diff=$(git diff --stat); jq -n --arg commits \"$commits\" --arg diff \"$diff\" \"{commits: \\$commits, diff: \\$diff}\"'"
    cache:
      deterministic: false
    timeout: 30

  verify:
    run: "bash scripts/verify.sh"
    cache:
      deterministic: false
    timeout: 180
