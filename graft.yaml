apiVersion: graft/v0
deps:
  meta-knowledge-base: "https://github.com/danielnaab/meta-knowledge-base.git#main"
  living-specifications: "https://github.com/danielnaab/living-specifications.git#main"

commands:
  plan:
    run: "cat"
    description: "Render planning prompt with project state"
    category: core
    example: "graft run software-factory:plan"
    stdin:
      template: templates/plan.md
    context:
      - changes
      - slices
      - verify

  iterate:
    run: "bash scripts/iterate.sh {slice}"
    description: "Generate implementation prompt for next step of a slice"
    category: core
    example: "graft run software-factory:iterate slices/my-feature"
    args:
      - name: slice
        type: choice
        description: "Slice to iterate on"
        required: true
        positional: true
        options_from: slices

  implement:
    run: "bash scripts/implement.sh {slice}"
    description: "Implement next slice step with Claude Code"
    category: core
    example: "graft run software-factory:implement slices/my-feature"
    writes:
      - session
      - context-snapshot
    args:
      - name: slice
        type: choice
        description: "Slice to implement"
        required: true
        positional: true
        options_from: slices

  resume:
    run: "bash scripts/resume.sh {slice}"
    description: "Resume the last implement session for a slice"
    category: diagnostic
    example: "graft run software-factory:resume slices/my-feature"
    reads:
      - session
    args:
      - name: slice
        type: choice
        description: "Slice to resume"
        required: true
        positional: true
        options_from: slices

  verify:
    run: "bash scripts/verify.sh"
    description: "Run consumer project verification (format, lint, tests)"
    category: core
    example: "graft run software-factory:verify"
    writes:
      - verify

  approve:
    run: "bash scripts/approve.sh"
    description: "Approve a pending checkpoint"
    category: core
    example: "graft run software-factory:approve"
    reads:
      - checkpoint

  reject:
    run: "bash scripts/reject.sh"
    description: "Reject a pending checkpoint"
    category: core
    example: "graft run software-factory:reject \"The output is missing error handling\""
    reads:
      - checkpoint
    args:
      - name: feedback
        type: string
        description: "Optional feedback for Claude on why the checkpoint was rejected"
        required: false
        positional: true

  review:
    run: "bash scripts/review.sh"
    description: "Adversarial self-review of implementation diff against acceptance criteria (advisory)"
    category: optional
    example: "graft run software-factory:review"
    reads:
      - session
    writes:
      - review

  diagnose:
    run: "bash scripts/diagnose.sh"
    description: "Targeted root-cause analysis for verify failures"
    category: diagnostic
    example: "graft run software-factory:diagnose"
    reads:
      - verify
      - session
    writes:
      - diagnose

  spec-check:
    run: "bash scripts/spec-check.sh"
    description: "Map acceptance criteria to implementation evidence in the diff"
    category: optional
    example: "graft run software-factory:spec-check"
    reads:
      - session
    writes:
      - spec-check

  new-slice:
    run: "bash scripts/new-slice.sh {description}"
    description: "Draft a new slice plan from a feature description"
    category: optional
    example: "graft run software-factory:new-slice \"add retry logic to sequences\""
    args:
      - name: description
        type: string
        description: "Feature description for the new slice"
        required: true
        positional: true

  implement-parallel:
    run: "bash scripts/implement-parallel.sh"
    description: "Run multiple independent slices in parallel using git worktrees"
    category: advanced
    example: "graft run software-factory:implement-parallel slices/feature-a slices/feature-b"
    args:
      - name: slice1
        type: string
        description: "First slice to implement"
        required: true
        positional: true
      - name: slice2
        type: string
        description: "Second slice to implement"
        required: true
        positional: true
      - name: slice3
        type: string
        description: "Third slice to implement (optional)"
        required: false
        positional: true
      - name: slice4
        type: string
        description: "Fourth slice to implement (optional)"
        required: false
        positional: true

sequences:
  implement-verified:
    description: "Implement next slice step and verify, retrying on verify failure"
    category: core
    example: "graft run software-factory:implement-verified slices/my-feature"
    steps:
      - implement
      - verify
    on_step_fail:
      step: verify
      recovery: resume
      max: 3
    checkpoint: true
    args:
      - name: slice
        type: choice
        description: "Slice to implement"
        required: true
        positional: true
        options_from: slices

  implement-reviewed:
    description: "Implement, verify (with retry), and self-review before human checkpoint"
    category: core
    example: "graft run software-factory:implement-reviewed slices/my-feature"
    steps:
      - implement
      - verify
      - review
    on_step_fail:
      step: verify
      recovery: resume
      max: 3
    checkpoint: true
    args:
      - name: slice
        type: choice
        description: "Slice to implement"
        required: true
        positional: true
        options_from: slices

state:
  slices:
    run: "bash scripts/list-slices.sh"
    timeout: 10

  changes:
    run: "bash -c 'commits=$(git log --oneline -10); diff=$(git diff --stat); jq -n --arg commits \"$commits\" --arg diff \"$diff\" \"{commits: \\$commits, diff: \\$diff}\"'"
    timeout: 30

  verify:
    run: "bash scripts/verify.sh"
    cache:
      inputs:
        - "**/*.rs"
        - "Cargo.toml"
        - "Cargo.lock"
        - "**/*.py"
        - "pyproject.toml"
        - "uv.lock"
    timeout: 180
